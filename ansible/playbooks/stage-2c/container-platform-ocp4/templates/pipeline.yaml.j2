---
stages:
  - .pre
  - bucket
  - destroy
  - delete_roles
  - networking
  - jumphost
  - prepare_coreos
  - install_ocp4
  - complete_install
  - finish_install
  - certmanager
  - configure
  - trident_backend
  - trident_frontend
  - ocp4_post_install
  - finalise

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - when: always

variables:
  INVENTORY_REPO: git@gitlab.noris.net:paas/openshift4/ocp4_inventory.git
  INVENTORY_VERSION: main
  PLAYBOOKS_REPO: git@gitlab.noris.net:paas/ansible-playbooks/playbooks-ocp4.git
  PLAYBOOKS_VERSION: main
  ANSIBLE_COLLECTIONS_PATHS: ${CI_PROJECT_DIR}/ansible_collections
  TAGS: "all"

image: harbor.prod.paas.pop.noris.de/noris/ansible-ee@sha256:aaa381173de2751ed08a9807a2cb7e85cfaf97a1a893cfbc3afe56c343bde2b6

.ansible-call: &ansible-call
  - ls -alt inventory/
  - ls -alt playbooks/
  - ansible-playbook -i inventory/ ${ANSIBLE_PARAMS} -e ansible_hashi_vault_role_id=${ANSIBLE_HASHI_VAULT_ROLE_ID} -e ansible_hashi_vault_secret_id=${ANSIBLE_HASHI_VAULT_SECRET_ID} -e ansible_hashi_vault_auth_method=approle -e ansible_hashi_vault_url=${ANSIBLE_HASHI_VAULT_ADDR} ${PLAYBOOK} -t ${TAGS}

before_script:
  - 'eval $(ssh-agent -s)'
  - 'echo "$SSH_KEY_AAP" | tr -d "\r" | ssh-add -'
  - 'if [ "${SSH_PRIVATE_TEAM_PASS}" != "" ]; then echo "${SSH_PRIVATE_TEAM_PASS}" | tr -d "\r" | ssh-add - > /dev/null; fi'
  - 'if [ "${SSH_PRIVATE_KEY_PAAS_INFRA}" != "" ]; then echo "${SSH_PRIVATE_KEY_PAAS_INFRA}" | tr -d "\r" | ssh-add - > /dev/null; fi'
  - 'if [ "${SSH_PRIVATE_SHELLSERVER}" != "" ]; then echo "${SSH_PRIVATE_SHELLSERVER}" | tr -d "\r" | ssh-add - > /dev/null; fi'
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - 'if [ "${SSH_KNOWN_HOSTS}" != "" ]; then echo "${SSH_KNOWN_HOSTS}" >> ~/.ssh/known_hosts; fi'
  - 'if [ "${SSH_CONFIG}" != "" ]; then echo "${SSH_CONFIG}" >> ~/.ssh/config; fi'
  - chmod 750 ${CI_PROJECT_DIR}

prepare:
  stage: .pre
  tags:
    - testing
  script:
    - set -x
    - git clone -b ${INVENTORY_VERSION} ${INVENTORY_REPO} inventory
    - git clone -b ${PLAYBOOKS_VERSION} ${PLAYBOOKS_REPO} playbooks
    - ansible-galaxy collection install ansible.utils
    - ansible-playbook -i inventory/ playbooks/render_roles.yml
  artifacts:
    paths:
      - playbooks
      - galaxy-roles
      - ansible_collections
      - inventory
    expire_in: 1 week
  rules:
    - when: always

create_s3_bucket:
  stage: bucket
  tags:
    - testing
  script:
    - *ansible-call
  variables:
    PLAYBOOK: "playbooks/s3_buckets.yml"
  rules:
    - if: $ENABLE_DELETE_JOB == "true"
      when: never
    - if: $MANAGE_S3_BUCKET == "false"
      when: never
    - if: $CI_COMMIT_REF_NAME == "master" && $HEADLESS_MODE == "true"
      when: always
    - when: manual
      allow_failure: true

build_network:
  stage: networking
  tags:
    - testing
  script:
    - *ansible-call
  variables:
    PLAYBOOK: "playbooks/setup_network.yml"
  rules:
    - if: $ENABLE_DELETE_JOB == "true"
      when: never
    - if: $CI_COMMIT_REF_NAME == "master" && $HEADLESS_MODE == "true"
      when: on_success
    - when: manual
      allow_failure: true

create_jumphost:
  stage: jumphost
  tags:
    - testing
  script:
    - *ansible-call
  variables:
    PLAYBOOK: "playbooks/create_jumphost.yml"
  rules:
    - if: $ENABLE_DELETE_JOB == "true"
      when: never
    - if: $CI_COMMIT_REF_NAME == "master" && $HEADLESS_MODE == "true"
      when: on_success
    - when: manual
      allow_failure: true

prepare_coreos_ova:
  stage: prepare_coreos
  tags:
    - testing
  script:
    - *ansible-call
  variables:
    PLAYBOOK: "playbooks/prepare_coreos_ova.yml"
  rules:
    - if: $ENABLE_DELETE_JOB == "true"
      when: never
    - if: $CI_COMMIT_REF_NAME == "master" && $HEADLESS_MODE == "true"
      when: on_success
    - when: manual
      allow_failure: true

install_ocp4:
  stage: install_ocp4
  tags:
    - testing
  script:
    - *ansible-call
  variables:
    PLAYBOOK: "playbooks/install_ocp4.yml"
  rules:
    - if: $ENABLE_DELETE_JOB == "true"
      when: never
    - if: $CI_COMMIT_REF_NAME == "master" && $HEADLESS_MODE == "true"
      when: on_success
    - when: manual
      allow_failure: true

complete_install_ocp4:
  stage: complete_install
  tags:
    - testing
  script:
    - *ansible-call
  variables:
    PLAYBOOK: "playbooks/complete_install_ocp4.yml"
  rules:
    - if: $ENABLE_DELETE_JOB == "true"
      when: never
    - if: $CI_COMMIT_REF_NAME == "master" && $HEADLESS_MODE == "true"
      when: on_success
    - when: manual
      allow_failure: true

finish_installation:
  stage: finish_install
  tags:
    - testing
  script:
    - *ansible-call
  variables:
    PLAYBOOK: "playbooks/finish_installation.yml"
  rules:
    - if: $ENABLE_DELETE_JOB == "true"
      when: never
    - if: $CI_COMMIT_REF_NAME == "master" && $HEADLESS_MODE == "true"
      when: on_success
    - when: manual
      allow_failure: true

certmanager:
  stage: certmanager
  tags:
    - testing
  script:
    - *ansible-call
  variables:
    PLAYBOOK: "playbooks/certmanager.yml"
  rules:
    - if: $ENABLE_DELETE_JOB == "true"
      when: never
    - if: $CI_COMMIT_REF_NAME == "master" && $HEADLESS_MODE == "true"
      when: on_success
    - when: manual
      allow_failure: true

configure_cluster:
  stage: configure
  tags:
    - testing
  script:
    - *ansible-call
  variables:
    PLAYBOOK: "playbooks/30-ocp4-cluster-post-install.yml"
    TAGS: "configure_cluster"
  rules:
    - if: $ENABLE_DELETE_JOB == "true"
      when: never
    - if: $CI_COMMIT_REF_NAME == "master" && $HEADLESS_MODE == "true"
      when: on_success
    - when: manual
      allow_failure: true

include:
##########################
# Core Installer / Plugins
##########################
  # Feature: Destroy Cluster
  - project: 'paas/ansible-roles/ocp4_cleanup'
    file: '.gitlab-ci-template.yml'
    ref: main

{% if plugin_cmdb_objects_enabled == True %}
  # Feature: Creation of objects in cmbd/kunde
  - project: 'paas/ansible-roles/create_cmdb_objects'
    file: '.gitlab-ci-template.yml'
    ref: main
{% endif %}

{% if plugin_extended_monitoring_enabled == True %}
  # Feature: Extended-monitoring
  - project: 'paas/ansible-roles/extended_monitoring'
    file: '.gitlab-ci-template.yml'
    ref: main
{% endif %}

{% if plugin_hashicorp_vault_enabled == True %}
  # Feature: Hashicorp Vault
  - project: 'paas/ansible-roles/hashicorp_vault'
    file: '.gitlab-ci-template.yml'
    ref: master
{% endif %}

{% if plugin_redhat_sso_enabled == True %}
  # Feature: Red Hat Single Sign-On
  - project: 'paas/ansible-roles/rhsso'
    file: '.gitlab-ci-template.yml'
    ref: main
{% endif %}

{% if plugin_trident_enabled == True %}
  # Feature: Trident Back- and Frontend
  - project: 'paas/ansible-roles/trident_frontend'
    file: '.gitlab-ci-template.yml'
    ref: main
{% endif %}

{% if plugin_ansible_automation_platform_enabled == True %}
  # Feature: Ansible Automation Platform
  - project: 'paas/ansible-roles/ansible_automation_platform'
    file: '.gitlab-ci-template.yml'
    ref: develop
{% endif %}

{% if plugin_logging_enabled == True %}
  # Feature: Openshift-Logging
  - project: 'paas/ansible-roles/ocp4_logging'
    file: '.gitlab-ci-template.yml'
    ref: main
{% endif %}

{% if plugin_alertmanager_enabled == True %}
  # Feature: Alertmanager
  - project: 'paas/ansible-roles/ocp4_alertmanager'
    file: '.gitlab-ci-template.yml'
    ref: main
{% endif %}

{% if plugin_pod_deployment_monitoring_enabled == True %}
  # Feature: Pod Deployment Monitoring
  - project: 'paas/ansible-roles/ocp4_pod_deployment_monitoring'
    file: '.gitlab-ci-template.yml'
    ref: main
{% endif %}

{% if plugin_jumphost_upgrade_enabled == True %}
  # Feature: Jumphost Upgrade
  - project: 'paas/ansible-roles/jumphost_upgrade'
    file: '.gitlab-ci-template.yml'
    ref: main
{% endif %}

{% if plugin_metallb_enabled == True %}
  # Feature: MetalLB
  - project: 'paas/ansible-roles/metallb'
    file: '.gitlab-ci-template.yml'
    ref: main
{% endif %}

{% if plugin_etcd_backup_enabled == True %}
  # Feature: etcd-Backup
  - project: 'paas/ansible-roles/etcd_backup'
    file: '.gitlab-ci-template.yml'
    ref: main
{% endif %}

{% if plugin_emails_enabled == True %}
  # Feature: Emails
  - project: 'paas/ansible-roles/send_email'
    file: '.gitlab-ci-template.yml'
    ref: main
{% endif %}
