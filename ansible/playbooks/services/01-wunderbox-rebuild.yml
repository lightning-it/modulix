---
# Purpose:
# - Orchestrate a full Wunderbox rebuild pipeline:
#   1) Destroy VM
#   2) Create VM from template
#   3) Wait for SSH bootstrap port
#   4) Base RHEL9 setup
#   5) Wunderbox configuration
#
# Usage:
# ansible-navigator run playbooks/services/01-wunderbox-rebuild.yml \
#   -i inventories/corp/inventory.yml --limit wunderbox01.prd.dmz.corp.l-it.io

- import_playbook: ../stage-1/infrastructure-platform-vsphere/90-vm-destroy.yml
- import_playbook: ../stage-1/infrastructure-platform-vsphere/20-vm-template.yml

- name: Wait for target SSH bootstrap port after VM creation
  hosts: all
  gather_facts: false
  tasks:
    - name: Wait for SSH port to be reachable
      ansible.builtin.wait_for:
        host: "{{ ansible_host | default(inventory_hostname) }}"
        port: "{{ linux_bootstrap_ssh_port | default(sshd_port | default(22)) | int }}"
        state: started
        delay: "{{ rebuild_vm_boot_wait_delay | default(20) }}"
        sleep: 5
        timeout: "{{ rebuild_vm_boot_wait_timeout | default(900) }}"
      delegate_to: localhost

- import_playbook: ../stage-2a/traditional-operating-systems/rhel9/01-base-setup.yml
- import_playbook: ../stage-2b/12-wunderbox.yml
