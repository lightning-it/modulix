#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd -- "${SCRIPT_DIR}/.." && pwd)"

SOURCE_ROOT_DEFAULT="$(cd -- "${REPO_ROOT}/../.." && pwd)"
SOURCE_ROOT="${SOURCE_ROOT:-${SOURCE_ROOT_DEFAULT}}"
TARGET_PATH="${TARGET_PATH:-${REPO_ROOT}/collections-dev}"

usage() {
  cat <<'EOF'
Usage:
  scripts/install-local-collections [options] [collection ...]

Build local ansible collection tarballs and install them into collections-dev
without interactive prompts.

Collection arguments:
  - short name: foundational, rhel, ocp, supplementary
  - absolute/relative path to a collection repo containing galaxy.yml

Options:
  --source-root <path>   Root containing ansible-collection-* repos
                         (default: ../../ from modulix/ansible)
  --target-path <path>   Install path for collections
                         (default: ./collections-dev)
  -h, --help             Show this help

Environment overrides:
  SOURCE_ROOT, TARGET_PATH
EOF
}

if ! command -v ansible-galaxy >/dev/null 2>&1; then
  echo "ansible-galaxy not found in PATH" >&2
  exit 1
fi

declare -a requested=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    --source-root)
      SOURCE_ROOT="$2"
      shift 2
      ;;
    --target-path)
      TARGET_PATH="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      while [[ $# -gt 0 ]]; do
        requested+=("$1")
        shift
      done
      ;;
    -*)
      echo "Unknown option: $1" >&2
      usage
      exit 2
      ;;
    *)
      requested+=("$1")
      shift
      ;;
  esac
done

declare -a collection_dirs=()
if [[ ${#requested[@]} -eq 0 ]]; then
  while IFS= read -r d; do
    collection_dirs+=("$d")
  done < <(find "${SOURCE_ROOT}" -maxdepth 1 -mindepth 1 -type d -name 'ansible-collection-*' | sort)
else
  for item in "${requested[@]}"; do
    if [[ -d "${item}" && -f "${item}/galaxy.yml" ]]; then
      collection_dirs+=("$(cd -- "${item}" && pwd)")
      continue
    fi

    candidate="${SOURCE_ROOT}/ansible-collection-${item}"
    if [[ -d "${candidate}" && -f "${candidate}/galaxy.yml" ]]; then
      collection_dirs+=("${candidate}")
      continue
    fi

    echo "Collection repo not found for '${item}'" >&2
    exit 1
  done
fi

if [[ ${#collection_dirs[@]} -eq 0 ]]; then
  echo "No collection repos found under ${SOURCE_ROOT}" >&2
  exit 1
fi

mkdir -p "${TARGET_PATH}"
build_dir="$(mktemp -d "${TMPDIR:-/tmp}/local-collections.XXXXXX")"
trap 'rm -rf "${build_dir}"' EXIT

declare -a artifacts=()
for dir in "${collection_dirs[@]}"; do
  if [[ ! -f "${dir}/galaxy.yml" ]]; then
    echo "Missing galaxy.yml in ${dir}" >&2
    exit 1
  fi

  namespace="$(awk -F': *' '$1=="namespace"{print $2; exit}' "${dir}/galaxy.yml")"
  name="$(awk -F': *' '$1=="name"{print $2; exit}' "${dir}/galaxy.yml")"
  version="$(awk -F': *' '$1=="version"{print $2; exit}' "${dir}/galaxy.yml")"

  echo "Building ${namespace}.${name} (${version}) from ${dir}"
  ansible-galaxy collection build --force --output-path "${build_dir}" "${dir}" >/dev/null

  artifact="${build_dir}/${namespace}-${name}-${version}.tar.gz"
  if [[ ! -f "${artifact}" ]]; then
    echo "Expected artifact not found: ${artifact}" >&2
    exit 1
  fi
  artifacts+=("${artifact}")
done

install_cmd=(ansible-galaxy collection install --force --offline --no-deps --collections-path "${TARGET_PATH}")
echo "Installing local artifacts only (offline, no deps)"
install_cmd+=("${artifacts[@]}")

"${install_cmd[@]}"

echo
echo "Installed ${#artifacts[@]} collection(s) into ${TARGET_PATH}"
for artifact in "${artifacts[@]}"; do
  echo "- $(basename "${artifact}")"
done
