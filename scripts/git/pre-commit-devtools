#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage:
  ./scripts/git/pre-commit-devtools [pre-commit args...]

Examples:
  ./scripts/git/pre-commit-devtools
  ./scripts/git/pre-commit-devtools run --all-files
  ./scripts/git/pre-commit-devtools run --files README.md

Environment:
  DEVTOOLS_ENGINE=auto|podman|docker                 (default: auto)
  DEVTOOLS_IMAGE=<image:tag>                         (default: localhost/ee-wunder-devtools-ubi9:local)
  PRE_COMMIT_CACHE_DIR=/path/to/cache                (default: $HOME/.cache/pre-commit)
  PRE_COMMIT_WORKSPACE=/path/to/repo                 (default: current working directory)
  DEVTOOLS_SKIP_DOCKER_HOOKS=auto|true|false         (default: auto)
EOF
}

detect_engine() {
  local requested="${1}"
  case "${requested}" in
    auto)
      if command -v podman >/dev/null 2>&1; then
        echo "podman"
        return 0
      fi
      if command -v docker >/dev/null 2>&1; then
        echo "docker"
        return 0
      fi
      echo "Neither podman nor docker is installed." >&2
      return 1
      ;;
    podman|docker)
      if command -v "${requested}" >/dev/null 2>&1; then
        echo "${requested}"
        return 0
      fi
      echo "Requested engine '${requested}' is not installed." >&2
      return 1
      ;;
    *)
      echo "Invalid DEVTOOLS_ENGINE='${requested}' (use: auto|podman|docker)." >&2
      return 1
      ;;
  esac
}

find_container_api_socket() {
  local uid
  uid="$(id -u)"

  if [[ -S "/var/run/docker.sock" ]]; then
    echo "/var/run/docker.sock"
    return 0
  fi

  if [[ -S "/run/docker.sock" ]]; then
    echo "/run/docker.sock"
    return 0
  fi

  if [[ -S "/run/user/${uid}/podman/podman.sock" ]]; then
    echo "/run/user/${uid}/podman/podman.sock"
    return 0
  fi

  return 1
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" || "${1:-}" == "help" ]]; then
  usage
  exit 0
fi

engine_requested="${DEVTOOLS_ENGINE:-auto}"
engine="$(detect_engine "${engine_requested}")"
image="${DEVTOOLS_IMAGE:-localhost/ee-wunder-devtools-ubi9:local}"
cache_dir="${PRE_COMMIT_CACHE_DIR:-$HOME/.cache/pre-commit}"
workspace_dir="${PRE_COMMIT_WORKSPACE:-$PWD}"
skip_docker_hooks="${DEVTOOLS_SKIP_DOCKER_HOOKS:-auto}"
container_home="/tmp/wunder"
container_cache_dir="${container_home}/.cache/pre-commit"
docker_hook_ids="hadolint-docker,actionlint,container-build,container-smoke,renovate-config-validate"

if ! workspace_dir_abs="$(readlink -f -- "${workspace_dir}")"; then
  echo "Cannot resolve workspace directory: ${workspace_dir}" >&2
  exit 1
fi

if [[ ! -d "${workspace_dir_abs}" ]]; then
  echo "Workspace directory does not exist: ${workspace_dir_abs}" >&2
  exit 1
fi

container_workspace="${workspace_dir_abs}"

case "${skip_docker_hooks}" in
  auto|true|false) ;;
  *)
    echo "Invalid DEVTOOLS_SKIP_DOCKER_HOOKS='${skip_docker_hooks}' (use: auto|true|false)." >&2
    exit 1
    ;;
esac

mkdir -p "${cache_dir}"

if ! "${engine}" image inspect "${image}" >/dev/null 2>&1; then
  cat >&2 <<EOF
Image '${image}' not found locally.
Build it first, for example:
  podman build --format docker -t localhost/ee-wunder-devtools-ubi9:local ../container-ee-wunder-devtools-ubi9
EOF
  exit 1
fi

mount_cache="${cache_dir}:${container_cache_dir}"
mount_workspace="${workspace_dir_abs}:${container_workspace}"
if [[ "${engine}" == "podman" ]]; then
  mount_cache="${mount_cache}:Z"
  mount_workspace="${mount_workspace}:z"
fi

run_args=("${engine}" run --rm)
if [[ -t 0 && -t 1 ]]; then
  run_args+=(-it)
fi

if [[ "${engine}" == "podman" ]]; then
  run_args+=(--security-opt label=disable)
  run_args+=(--userns=keep-id)
  run_args+=(--group-add keep-groups)
fi

run_args+=(
  --user "$(id -u):$(id -g)"
  -v "${mount_workspace}"
  -w "${container_workspace}"
  -e "HOME=${container_home}"
  -e "PRE_COMMIT_HOME=${container_cache_dir}"
  -e "GIT_CONFIG_COUNT=1"
  -e "GIT_CONFIG_KEY_0=safe.directory"
  -e "GIT_CONFIG_VALUE_0=${container_workspace}"
  -v "${mount_cache}"
)

if container_api_socket="$(find_container_api_socket)"; then
  socket_mount="${container_api_socket}:/var/run/docker.sock"
  if [[ "${engine}" == "podman" ]]; then
    socket_mount="${socket_mount}:U"
  fi
  run_args+=(-v "${socket_mount}")
  run_args+=(-e "DOCKER_HOST=unix:///var/run/docker.sock")
else
  case "${skip_docker_hooks}" in
    auto|true)
      if [[ -n "${SKIP:-}" ]]; then
        run_args+=(-e "SKIP=${SKIP},${docker_hook_ids}")
      else
        run_args+=(-e "SKIP=${docker_hook_ids}")
      fi
      echo "No container API socket found; skipping docker-based hooks: ${docker_hook_ids}" >&2
      ;;
    false)
      echo "No container API socket found; docker-based hooks may fail." >&2
      ;;
  esac
fi

if [[ $# -eq 0 ]]; then
  pre_commit_args=(run --all-files)
else
  pre_commit_args=("$@")
fi

exec "${run_args[@]}" "${image}" pre-commit "${pre_commit_args[@]}"
